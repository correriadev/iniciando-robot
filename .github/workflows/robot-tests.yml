name: CI - Controlled Robot Tests with Secrets

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  robot-tests:
    runs-on: ubuntu-latest

    env:
      BACK_REPO_URL: https://github.com/juniorschmitz/cinema-challenge-back
      FRONT_REPO_URL: https://github.com/juniorschmitz/cinema-challenge-front
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      PORT: 3000

    steps:
    - name: Checkout test repository
      uses: actions/checkout@v4

    - name: Clone Backend repository
      run: git clone $BACK_REPO_URL cinema-challenge-back

    - name: Install Backend dependencies
      run: |
        cd cinema-challenge-back
        npm install

    - name: Create .env file for Backend
      run: |
        cd cinema-challenge-back
        echo "MONGODB_URI=${MONGODB_URI}" >> .env
        echo "PORT=${PORT}" >> .env

    - name: Start Backend and capture log
      run: |
        cd cinema-challenge-back
        npm start > backend.log 2>&1 &
    
    - name: Wait for Backend to be ready
      run: |
          for i in {1..30}; do
            if curl -s http://localhost:3000/api/v1/status >/dev/null; then
              echo "Backend is up!"
              exit 0
            fi
            echo "Waiting for backend..."
            sleep 2
            cat cinema-challenge-back/backend.log || true
          done
          echo "Backend did not respond in time."
          exit 1

    - name: Clone Frontend repository
      run: git clone $FRONT_REPO_URL cinema-challenge-front

    - name: Set up Python and Robot Framework
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Robot Framework dependencies
      run: |
        pip install -r requirements.txt
        pip install robotframework-requests

    - name: Run Robot Framework tests
      run: |
        mkdir -p results
        robot -d results tests/

    - name: Upload Robot Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: robot-test-reports
        path: results
