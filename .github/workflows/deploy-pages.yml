name: GEMINI_DEPLOY_GITHUB_PAGES_CD

on:
  workflow_run:
    workflows: ["ROBOT_TESTS_CI"]
    types:
      - completed

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    if: github.event.workflow_run.conclusion == 'success'
    
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ⬇️ Download artifact from the completed workflow
        uses: actions/download-artifact@v4
        with:
          name: robot-test-reports
          path: public
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: ⚙️ Configure Pages
        uses: actions/configure-pages@v5

      - name: 📊 Check test results, send to Gemini and update report
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          sudo apt-get update && sudo apt-get install -y jq

          if [ ! -f public/output.xml ]; then
            echo "Arquivo output.xml não encontrado!"
            exit 1
          fi

          FAILED_COUNT=$(grep -oP 'fail="\K[0-9]+' public/output.xml | head -1)
          if [ -z "$FAILED_COUNT" ]; then
            FAILED_COUNT=0
          fi

          if [ "$FAILED_COUNT" -eq 0 ]; then
            PROMPT="Todos os testes passaram com sucesso. Não há erros. Pode confirmar que o sistema está saudável?"
          else
            PROMPT="Foram encontrados $FAILED_COUNT erros nos testes automatizados. Abaixo está um trecho do relatório. Forneça insights ou possíveis causas para as falhas."
          fi

          SUMMARY=$(head -n 50 public/report.html | sed 's/"/\\"/g')

          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent" \
          -H "Content-Type: application/json" \
          -H "X-goog-api-key: $GEMINI_API_KEY" \
          -X POST \
          -d "{
                \"contents\": [
                  {
                    \"parts\": [
                      {\"text\": \"$PROMPT\"},
                      {\"text\": \"$SUMMARY\"}
                    ]
                  }
                ]
              }")

          INSIGHT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text')

          HTML_BLOCK="<div style='border: 2px solid #333; padding: 1em; margin: 1em 0; background: #f9f9f9;'><h2>💡 Insights gerados pelo Gemini AI</h2><p>$INSIGHT</p></div>"

          sed -i "/<\/body>/i $HTML_BLOCK" public/report.html

      - name: 📦 Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: 📢 Publish to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
